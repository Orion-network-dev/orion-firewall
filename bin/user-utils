#!/bin/bash

# Update the nftables rules with the user id
MEMBER_ID=$(/usr/lib/orion-firewall/member-id)
sed "/__TODO__/c\define myself = 10.30.$MEMBER_ID.0" /etc/orion-firewall/nftables.conf.tmpl > /etc/orion-firewall/nftables.conf
/etc/nftables.conf

# Simple function to add add a IP redirection
# Used like so: route_ip "<orion ip>" "<local ip>" "<port>"
function route_ip {
    orionAddress=$1
    localAddress=$2
    port=$3

    # Add the ports mappings
    nft add element inet orion ports { $orionAddress . $port : $localAddress . $port }
    nft add element inet orion snat_ports { $localAddress . $port : $orionAddress . $port }
    
    # Add the icmp mappings
    nft add element inet orion icmp_map { $orionAddress : $localAddress }
    nft add element inet orion snat_icmp_map { $localAddress : $orionAddress }
}

